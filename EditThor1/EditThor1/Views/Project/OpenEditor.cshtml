@model EditThor1.Models.ViewModels.ListFileViewModel
@using EditThor1.Controllers;
@{
    ViewBag.Title = "OpenEditor";
}


<h2 class="project-name">@ViewBag.ProjectName</h2>
<div class="row" id="editorContainer">

    <div class="col-md-2 col-sm-6 col-xs-12 col-xxs-12" id="filecolumn">
        @Html.ActionLink("New File", "CreateFile", new { controller = "Project",  id = Model.ProjectId }, new { @class = " custom-btn col-md-12" })
            <ul id="filelist">
                @foreach (var item in Model.AllFiles)
                {
                    if (Model.FileId == item.ID)
                    {
                        <li class="active filelist-item">@Html.ActionLink(item.Name, "DisplayFile", new { id = item.ID, projectID = item.ProjectID })</li>
                    }
                    else
                    {
                        <li class="filelist-item">@Html.ActionLink(item.Name, "DisplayFile", new { id = item.ID, projectID = item.ProjectID })</li>
                    }
                    //@Html.ActionLink("Edit Category 10", "Edit", "Categorys", new { area = "Admin", id = 10 }, null)

                }
            </ul>
        <div class="col-md-12 col-sm-12" id="project-info" >
            <ul id="user-list">
                @foreach (string username in Model.Users)
                {
                    <li class="user">@username</li>
                }
            </ul>
        </div>
    </div>
    <div class="col-md-8 col-sm-6 col-xs-12 col-xxs-12">
        <div id="editor">@Model.Content</div>
    </div>
</div>
<div class="form-group" style="height:50px">
    <div class="col-md-6 col-sm-6 col-xs-12 col-xxs-12">
    @if (Model.FileId != 0)
    {
        using (Html.BeginForm("Save", "Project", FormMethod.Post, new { id = "form1" }))
        {
            @Html.HiddenFor(m => m.Content, new { @id = "hidden_editor" })
            @Html.HiddenFor(m => m.FileId)
            @Html.HiddenFor(m => m.ProjectId)
            <input type="submit" value="&#128190; Save file (Ctrl+S)" class="btn btn-success save-butt" />
        }
    }
    </div>
    <div class="col-md-offset-4 col-md-2 col-sm-6 col-xs-12 col-xxs-12">
        @using (Html.BeginForm("DeleteFile", "Project", FormMethod.Post, new { id = "form2" }))
        {
            @Html.HiddenFor(m => m.FileId)
            @Html.HiddenFor(m => m.ProjectId)
            <input type="submit" value="&#128465; Delete file" class="btn btn-danger delete-butt" name="delete" />
        }
    </div>
</div>


@section scripts
{
<script src="@Url.Content("~/Scripts/ace-builds-master/ace-builds-master/src-noconflict/ace.js")"></script>
<script src='jquery/jquery.js' type="text/javascript"></script>
<script src='jquery/jquery-ui.custom.js' type="text/javascript"></script>
<script src="~/Scripts/jquery.signalR-2.2.2.js"></script>
<script src="~/signalr/hubs"></script>
<script>
    $(document).ready(function(){
        $("input[name='delete']").click(function() {
            return confirm('Are you sure you want to delete this file?');
        });
    });

    var documentID = @Model.ProjectId;
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/@Model.Theme");
    editor.renderer.theme.green;
    editor.getSession().setMode("ace/mode/@Model.Filetype");
    editor.setOption("firstLineNumber", 1)



    $("#form1").submit(function() {
        $("#hidden_editor").val(editor.getSession().getValue());
    });

    var codeHub = $.connection.codeHub;
    var silent = false;

    codeHub.client.onChange = function (changeData) {
        console.log(changeData);

        silent = true;
        editor.getSession().getDocument().applyDelta(changeData);
        silent = false;
    };

    $.connection.hub.start().done(function () {

        codeHub.server.joinDocument(documentID);

        editor.on("change", function (obj) {
            if (silent)
            {
                return;
            }
            console.log(obj);
            codeHub.server.onChange(obj, documentID);
        });
    });
    // til að leyfa Ctrl+S til að vista skrá
    $(document).keydown(function(event) {
        //19 for Mac Command+S
        if (!( String.fromCharCode(event.which).toLowerCase() == 's' && event.ctrlKey) && !(event.which == 19)) return true;
        event.preventDefault();

        $('#form1').submit();
        return false;
    });

</script>
}


